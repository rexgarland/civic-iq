<head>
  <link
    href="https://fonts.googleapis.com/css?family=Montserrat:300,400,700|Roboto:400,700"
    rel="stylesheet"
  />
  <link href="style.css" rel="stylesheet" type="text/css" />
  <title>Civic IQ Results</title>
  <link rel="icon" type="x-icon" href="icon.png" />
  <link rel="shortcut icon" type="x-icon" href="icon.png" />
  <meta charset="utf-8" />
</head>

<body>
  <h1>Civic IQ</h1>
  <hr />

  <h1>Results</h1>
  <h2 id="score"></h2>
  <div id="breakdown"></div>
  <hr />
  <button class="button" onclick="location.href='index.html';">Back</button>
  <br />

  <script type="application/javascript" src="questions.js"></script>
  <script>
    function problem(msg) {
      alert(`Error: ${msg}\nPlease contact maintainers to fix.`);
    }

    function getAnswersFromWindowURL() {
      var url = new URL(window.location);
      const data = url.searchParams.get("data");
      if (data === null) {
        problem("Could not find quiz answers within URL.");
        return;
      }

      try {
        return JSON.parse(atob(data));
      } catch {
        problem("Could not parse quiz answers.");
      }
    }

    function findMistakes(questions, answers) {
      const mistakes = [];

      for (let i = 0; i < questions.length; i++) {
        const question = questions[i];
        const correctAnswer = question.answer;
        const chosenIndex = answers[i];
        const chosenOption = question.options[chosenIndex];

        if (chosenOption !== correctAnswer) {
          mistakes.push({
            question,
            answer: correctAnswer,
            choice: chosenOption,
          });
        }
      }

      return mistakes;
    }

    function generateCardFrom(mistake) {
      const card = document.createElement("div");
      card.style.marginBottom = "24px";
      const { question, choice, answer } = mistake;
      card.innerHTML = `<h3 style="font-size: 18pt; margin-bottom: 12px;">${question.text}</h3><p>You chose "${choice}", when the correct answer was "${answer}".</p>`;
      return card;
    }

    function renderMistakeBreakdownIn(div, mistakes) {
      if (mistakes.length === 0) {
        return;
      }

      const header = document.createElement("h2");
      header.innerHTML = "These questions were incorrect:";
      div.appendChild(header);

      for (const mistake of mistakes) {
        div.appendChild(generateCardFrom(mistake));
      }
    }

    // main

    const answers = getAnswersFromWindowURL();

    const total = questions.length;
    if (!answers) {
      problem("Could not find all answers for calculating quiz results.");
    }
    if (answers.length !== total) {
      problem(`${answers.length} answers found for quiz of length ${total}.`);
    }

    const mistakes = findMistakes(questions, answers);
    const score = total - mistakes.length;

    document.getElementById(
      "score"
    ).innerHTML = `You got ${score}/${total} (${Math.round(
      (score / total) * 100
    )}%) correct!`;

    const breakdown = document.getElementById("breakdown");

    renderMistakeBreakdownIn(breakdown, mistakes);
  </script>
</body>
